=Module <<a_api_type subproject="server" | module Os_session >> =
<<pre class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|module>> <<span class="ocsforge_color_uid"|<<span class="ocsforge_color_uid"|Os_session>>>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="ocsforge_color_keyword"|sig>><<a_api subproject="server" text=".." | module Os_session >><<span class="ocsforge_color_keyword"|end>>>>~Connection and disconnection of users~,
    restrict access to services or server functions~,
    define actions to be executed at some points of the session~.

----
<<pre id="VALon_start_process" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|on~_start~_process>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|<<span class="ocsforge_color_delimiter"| ( >>unit <<span class="ocsforge_color_delimiter"| -> >> unit <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>><<span class="ocsforge_color_delimiter"| ) >> <<span class="ocsforge_color_delimiter"| -> >> unit>>>><<div class="odocwiki_info"|~Call this to add an action to be done on server side
    when the process starts
>>
<<pre id="VALon_start_connected_process" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|on~_start~_connected~_process>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|<<span class="ocsforge_color_delimiter"| ( >><<a_api subproject="server" text="Os_types.User.id" | type Os_types.User.id >> <<span class="ocsforge_color_delimiter"| -> >> unit <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>><<span class="ocsforge_color_delimiter"| ) >> <<span class="ocsforge_color_delimiter"| -> >> unit>>>><<div class="odocwiki_info"|~Call this to add an action to be done
    when the process starts in connected mode~, or when the user logs in
>>
<<pre id="VALon_connected_request" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|on~_connected~_request>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|<<span class="ocsforge_color_delimiter"| ( >><<a_api subproject="server" text="Os_types.User.id" | type Os_types.User.id >> <<span class="ocsforge_color_delimiter"| -> >> unit <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>><<span class="ocsforge_color_delimiter"| ) >> <<span class="ocsforge_color_delimiter"| -> >> unit>>>><<div class="odocwiki_info"|~Call this to add an action to be done at each connected request~.
    ~The function takes the user id as parameter~.
>>
<<pre id="VALon_unconnected_request" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|on~_unconnected~_request>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|<<span class="ocsforge_color_delimiter"| ( >>unit <<span class="ocsforge_color_delimiter"| -> >> unit <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>><<span class="ocsforge_color_delimiter"| ) >> <<span class="ocsforge_color_delimiter"| -> >> unit>>>><<div class="odocwiki_info"|~Call this to add an action to be done at each unconnected request~.
>>
<<pre id="VALon_open_session" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|on~_open~_session>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|<<span class="ocsforge_color_delimiter"| ( >><<a_api subproject="server" text="Os_types.User.id" | type Os_types.User.id >> <<span class="ocsforge_color_delimiter"| -> >> unit <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>><<span class="ocsforge_color_delimiter"| ) >> <<span class="ocsforge_color_delimiter"| -> >> unit>>>><<div class="odocwiki_info"|~Call this to add an action to be done just after opening a session
    ~The function takes the user id as parameter~.
>>
<<pre id="VALon_pre_close_session" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|on~_pre~_close~_session>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|<<span class="ocsforge_color_delimiter"| ( >>unit <<span class="ocsforge_color_delimiter"| -> >> unit <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>><<span class="ocsforge_color_delimiter"| ) >> <<span class="ocsforge_color_delimiter"| -> >> unit>>>><<div class="odocwiki_info"|~Call this to add an action to be done just before closing the session
>>
<<pre id="VALon_post_close_session" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|on~_post~_close~_session>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|<<span class="ocsforge_color_delimiter"| ( >>unit <<span class="ocsforge_color_delimiter"| -> >> unit <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>><<span class="ocsforge_color_delimiter"| ) >> <<span class="ocsforge_color_delimiter"| -> >> unit>>>><<div class="odocwiki_info"|~Call this to add an action to be done just after closing the session
>>
<<pre id="VALon_request" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|on~_request>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|<<span class="ocsforge_color_delimiter"| ( >>unit <<span class="ocsforge_color_delimiter"| -> >> unit <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>><<span class="ocsforge_color_delimiter"| ) >> <<span class="ocsforge_color_delimiter"| -> >> unit>>>><<div class="odocwiki_info"|~Call this to add an action to be done just before handling a request
>>
<<pre id="VALon_denied_request" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|on~_denied~_request>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|<<span class="ocsforge_color_delimiter"| ( >><<a_api subproject="server" text="Os_types.User.id" | type Os_types.User.id >> option <<span class="ocsforge_color_delimiter"| -> >> unit <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>><<span class="ocsforge_color_delimiter"| ) >> <<span class="ocsforge_color_delimiter"| -> >> unit>>>><<div class="odocwiki_info"|~Call this to add an action to be done just for each denied request~.
    ~The function takes the user id as parameter~, if some user is connected~.
>>
<<pre id="VALuser_indep_state_hierarchy" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|user~_indep~_state~_hierarchy>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|<<span class="ocsforge_color_uid"|Eliom_common>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|scope_hierarchy>>>>>><<div class="odocwiki_info"|~Scopes that are independant from user connection~.
    ~Use this scopes for example when you want to store
    server side data for one browser or tab~, but not user dependant~.
    ~(~Remains when user logs out~)~.
>>
<<pre id="VALuser_indep_process_scope" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|user~_indep~_process~_scope>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|<<span class="ocsforge_color_uid"|Eliom_common>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|client_process_scope>>>>>><<pre id="VALuser_indep_session_scope" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|user~_indep~_session~_scope>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|<<span class="ocsforge_color_uid"|Eliom_common>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|session_scope>>>>>><<pre id="EXCEPTIONNot_connected" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|exception>> <<span class="odocwiki_name"|Not_connected>>>><<pre id="EXCEPTIONPermission_denied" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|exception>> <<span class="odocwiki_name"|Permission_denied>>>><<pre id="VALconnect" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|connect>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|<<span class="ocsforge_color_label"| ?expire: >>bool <<span class="ocsforge_color_delimiter"| -> >> <<a_api subproject="server" text="Os_types.User.id" | type Os_types.User.id >> <<span class="ocsforge_color_delimiter"| -> >> unit <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>>>>>><<div class="odocwiki_info"|~Open a session for a user by setting a session group for the browser
    which initiated the current request~.
    ~Ocsigen~-start is using both persistent and volatile session groups~.
    ~The volatile groups is recreated from persistent group if absent~.
    ~By default~, the connection does not expire~; by setting the optional
    argument <<span class="odocwiki_inlinecode"|expire>> to true~, the session will expire when the browser
    exits~.
>>
<<pre id="VALdisconnect" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|disconnect>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|unit <<span class="ocsforge_color_delimiter"| -> >> unit <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>>>>>><<div class="odocwiki_info"|~Close a session by discarding server side states for current browser
    ~(session and session group~)~, current client process ~(tab~) and current
    request~.
    ~Only default ~Eliom scopes are affected~, but not user independant scopes~.
    ~The actions registered for session close ~(by <<span class="odocwiki_inlinecode"|on~_close~_session>>~)
    will be executed just before the session is actually closed~.
>>
<<pre id="VALconnected_fun" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|connected~_fun>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|\\  <<span class="ocsforge_color_label"| ?allow: >><<a_api subproject="server" text="Os_types.Group.t" | type Os_types.Group.t >> list <<span class="ocsforge_color_delimiter"| -> >>\\  <<span class="ocsforge_color_label"| ?deny: >><<a_api subproject="server" text="Os_types.Group.t" | type Os_types.Group.t >> list <<span class="ocsforge_color_delimiter"| -> >>\\  <<span class="ocsforge_color_label"| ?deny_fun: >><<span class="ocsforge_color_delimiter"| ( >><<a_api subproject="server" text="Os_types.User.id" | type Os_types.User.id >> option <<span class="ocsforge_color_delimiter"| -> >> 'c <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>><<span class="ocsforge_color_delimiter"| ) >> <<span class="ocsforge_color_delimiter"| -> >>\\  <<span class="ocsforge_color_delimiter"| ( >><<a_api subproject="server" text="Os_types.User.id" | type Os_types.User.id >> <<span class="ocsforge_color_delimiter"| -> >> 'a <<span class="ocsforge_color_delimiter"| -> >> 'b <<span class="ocsforge_color_delimiter"| -> >> 'c <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>><<span class="ocsforge_color_delimiter"| ) >> <<span class="ocsforge_color_delimiter"| -> >> 'a <<span class="ocsforge_color_delimiter"| -> >> 'b <<span class="ocsforge_color_delimiter"| -> >> 'c <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>>>>>><<div class="odocwiki_info"|~Wrapper for service handlers that fetches automatically connection
    information~.
    ~Register <<span class="odocwiki_inlinecode"|~(connected~_fun f~)>> as handler for your services~,
    where <<span class="odocwiki_inlinecode"|f>> is a function taking user id~, ~G~E~T parameters and ~P~O~S~T parameters~.
    ~If no user is connected~, the service will fail by raising <<span class="odocwiki_inlinecode"|~Not~_connected>>~.
    ~Otherwise it calls function <<span class="odocwiki_inlinecode"|f>>~.
    ~To provide another behaviour in case the user is not connected~,
    have a look at <<a_api subproject="server" | val Os_session.Opt.connected_fun >> or module <<a_api subproject="server" | module Os_page >>~.


    ~Arguments <<span class="odocwiki_inlinecode"|~?allow>> and <<span class="odocwiki_inlinecode"|~?deny>> make possible to restrict access to some
    user groups~. ~If access is denied~, function <<span class="odocwiki_inlinecode"|~?deny~_fun>> will be called~.
    ~By default~, it raises <<span class="odocwiki_inlinecode"|~Permission denied>>~.


    ~When called on client side~, no security check is done~.


    ~If optional argument <<span class="odocwiki_inlinecode"|force~_unconnected>> is <<span class="odocwiki_inlinecode"|true>>~,
    it will not try to find session information~, and behave as if user were
    not connected ~(default is <<span class="odocwiki_inlinecode"|false>>~)~. ~This allows to use functions
    from module <<a_api subproject="server" | module Os_current_user >> in functions outside application
    without failing~.


    ~Use only one connection wrapper for each request!
>>
<<pre id="VALconnected_rpc" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|connected~_rpc>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|\\  <<span class="ocsforge_color_label"| ?allow: >><<a_api subproject="server" text="Os_types.Group.t" | type Os_types.Group.t >> list <<span class="ocsforge_color_delimiter"| -> >>\\  <<span class="ocsforge_color_label"| ?deny: >><<a_api subproject="server" text="Os_types.Group.t" | type Os_types.Group.t >> list <<span class="ocsforge_color_delimiter"| -> >>\\  <<span class="ocsforge_color_label"| ?deny_fun: >><<span class="ocsforge_color_delimiter"| ( >><<a_api subproject="server" text="Os_types.User.id" | type Os_types.User.id >> option <<span class="ocsforge_color_delimiter"| -> >> 'b <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>><<span class="ocsforge_color_delimiter"| ) >> <<span class="ocsforge_color_delimiter"| -> >>\\  <<span class="ocsforge_color_delimiter"| ( >><<a_api subproject="server" text="Os_types.User.id" | type Os_types.User.id >> <<span class="ocsforge_color_delimiter"| -> >> 'a <<span class="ocsforge_color_delimiter"| -> >> 'b <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>><<span class="ocsforge_color_delimiter"| ) >> <<span class="ocsforge_color_delimiter"| -> >> 'a <<span class="ocsforge_color_delimiter"| -> >> 'b <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>>>>>><<div class="odocwiki_info"|~Wrapper for server functions ~(see <<a_api subproject="server" | val Os_session.connected_fun >>~)~.
>>
<<pre id="VALconnected_wrapper" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|connected~_wrapper>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|\\  <<span class="ocsforge_color_label"| ?allow: >><<a_api subproject="server" text="Os_types.Group.t" | type Os_types.Group.t >> list <<span class="ocsforge_color_delimiter"| -> >>\\  <<span class="ocsforge_color_label"| ?deny: >><<a_api subproject="server" text="Os_types.Group.t" | type Os_types.Group.t >> list <<span class="ocsforge_color_delimiter"| -> >>\\  <<span class="ocsforge_color_label"| ?deny_fun: >><<span class="ocsforge_color_delimiter"| ( >><<a_api subproject="server" text="Os_types.User.id" | type Os_types.User.id >> option <<span class="ocsforge_color_delimiter"| -> >> 'b <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>><<span class="ocsforge_color_delimiter"| ) >> <<span class="ocsforge_color_delimiter"| -> >>\\  <<span class="ocsforge_color_label"| ?force_unconnected: >>bool <<span class="ocsforge_color_delimiter"| -> >> <<span class="ocsforge_color_delimiter"| ( >>'a <<span class="ocsforge_color_delimiter"| -> >> 'b <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>><<span class="ocsforge_color_delimiter"| ) >> <<span class="ocsforge_color_delimiter"| -> >> 'a <<span class="ocsforge_color_delimiter"| -> >> 'b <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>>>>>><<div class="odocwiki_info"|~Wrapper for server functions when you do not need userid
    ~(see <<a_api subproject="server" | val Os_session.connected_fun >>~)~.
    ~It is recommended to use this wrapper for all your server functions!
>>
<<pre class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|module>> <<a_api subproject="server" text="Opt" | module Os_session.Opt >> <<span class="ocsforge_color_delimiter"|~:>> <<span class="ocsforge_color_keyword"|sig>><<a_api subproject="server" text=".." | module Os_session.Opt >><<span class="ocsforge_color_keyword"|end>>>>