=Module <<a_api_type | module Ocsipersist >> =
<<pre class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|module>> <<span class="ocsforge_color_uid"|<<span class="ocsforge_color_uid"|Ocsipersist>>>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="ocsforge_color_keyword"|sig>><<a_api text=".." | module Ocsipersist >><<span class="ocsforge_color_keyword"|end>>>>~Persistent data on hard disk~.

----

~There are currently three implementations of this module~,
   one using a ~D~B~M database~, on the ~Postgre~S~Q~L database~,
   and one using ~S~Q~L~I~T~E~. ~Link the one your want with your program~.


==@@id="2_Persistentreferences"@@~Persistent references==


~When launching the program~, if the value exists on hard disk~,
    it is loaded~, otherwise it is initialised to the default value
<<pre class="ocsforge_color odocwiki_code" id="TYPEt"|<<span class="ocsforge_color_keyword"|type>> <<span class="odocwiki_type"|'a>> <<span class="odocwiki_name"|t>>>><<div class="odocwiki_info"|~Type of persistent data
>>
<<pre class="ocsforge_color odocwiki_code" id="TYPEstore"|<<span class="ocsforge_color_keyword"|type>> <<span class="odocwiki_name"|store>>>><<div class="odocwiki_info"|~Data are divided into stores~.
    ~Create one store for your project~, where you will save all your data~.
>>
<<pre id="VALopen_store" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|open~_store>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|string <<span class="ocsforge_color_delimiter"| -> >> <<a_api text="store" | type Ocsipersist.store >> <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>>>>>><<div class="odocwiki_info"|~Open a store ~(and create it if it does not exist~)
>>
<<pre id="VALmake_persistent" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|make~_persistent>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|\\  <<span class="ocsforge_color_label"| store: >><<a_api text="store" | type Ocsipersist.store >> <<span class="ocsforge_color_delimiter"| -> >>\\  <<span class="ocsforge_color_label"| name: >>string <<span class="ocsforge_color_delimiter"| -> >> <<span class="ocsforge_color_label"| default: >>'a <<span class="ocsforge_color_delimiter"| -> >> 'a <<a_api text="t" | type Ocsipersist.t >> <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>>>>>><<div class="odocwiki_info"|<<span class="odocwiki_inlinecode"|make~_persistent store name default>> find a persistent value
    named <<span class="odocwiki_inlinecode"|name>> in store <<span class="odocwiki_inlinecode"|store>>
    from database~, or create it with the default value <<span class="odocwiki_inlinecode"|default>> if it
    does not exist~.
>>
<<pre id="VALmake_persistent_lazy" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|make~_persistent~_lazy>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|\\  <<span class="ocsforge_color_label"| store: >><<a_api text="store" | type Ocsipersist.store >> <<span class="ocsforge_color_delimiter"| -> >>\\  <<span class="ocsforge_color_label"| name: >>string <<span class="ocsforge_color_delimiter"| -> >> <<span class="ocsforge_color_label"| default: >><<span class="ocsforge_color_delimiter"| ( >>unit <<span class="ocsforge_color_delimiter"| -> >> 'a<<span class="ocsforge_color_delimiter"| ) >> <<span class="ocsforge_color_delimiter"| -> >> 'a <<a_api text="t" | type Ocsipersist.t >> <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>>>>>><<div class="odocwiki_info"|~Same as make~_persistent but the default value is evaluated only
    if needed
>>
<<pre id="VALmake_persistent_lazy_lwt" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|make~_persistent~_lazy~_lwt>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|\\  <<span class="ocsforge_color_label"| store: >><<a_api text="store" | type Ocsipersist.store >> <<span class="ocsforge_color_delimiter"| -> >>\\  <<span class="ocsforge_color_label"| name: >>string <<span class="ocsforge_color_delimiter"| -> >> <<span class="ocsforge_color_label"| default: >><<span class="ocsforge_color_delimiter"| ( >>unit <<span class="ocsforge_color_delimiter"| -> >> 'a <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>><<span class="ocsforge_color_delimiter"| ) >> <<span class="ocsforge_color_delimiter"| -> >> 'a <<a_api text="t" | type Ocsipersist.t >> <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>>>>>><<div class="odocwiki_info"|~Lwt version of make~_persistent~_lazy~.
>>
<<pre id="VALget" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|get>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|'a <<a_api text="t" | type Ocsipersist.t >> <<span class="ocsforge_color_delimiter"| -> >> 'a <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>>>>>><<div class="odocwiki_info"|<<span class="odocwiki_inlinecode"|get pv>> gives the value of <<span class="odocwiki_inlinecode"|pv>>
>>
<<pre id="VALset" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|set>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|'a <<a_api text="t" | type Ocsipersist.t >> <<span class="ocsforge_color_delimiter"| -> >> 'a <<span class="ocsforge_color_delimiter"| -> >> unit <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>>>>>><<div class="odocwiki_info"|<<span class="odocwiki_inlinecode"|set pv value>> sets a persistent value <<span class="odocwiki_inlinecode"|pv>> to <<span class="odocwiki_inlinecode"|value>>
>>


==@@id="2_Persistenttables"@@~Persistent tables==

<<pre class="ocsforge_color odocwiki_code" id="TYPEtable"|<<span class="ocsforge_color_keyword"|type>> <<span class="odocwiki_type"|'value>> <<span class="odocwiki_name"|table>>>><<div class="odocwiki_info"|~Type of persistent table
>>
<<pre id="VALtable_name" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|table~_name>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|'value <<a_api text="table" | type Ocsipersist.table >> <<span class="ocsforge_color_delimiter"| -> >> string <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>>>>>><<div class="odocwiki_info"|returns the name of the table
>>
<<pre id="VALopen_table" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|open~_table>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|string <<span class="ocsforge_color_delimiter"| -> >> 'value <<a_api text="table" | type Ocsipersist.table >> <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>>>>>><<div class="odocwiki_info"|~Open a table ~(and create it if it does not exist~)
>>
<<pre id="VALfind" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|find>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|'value <<a_api text="table" | type Ocsipersist.table >> <<span class="ocsforge_color_delimiter"| -> >> string <<span class="ocsforge_color_delimiter"| -> >> 'value <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>>>>>><<div class="odocwiki_info"|<<span class="odocwiki_inlinecode"|find table key>> gives the value associated to <<span class="odocwiki_inlinecode"|key>>~.
    ~Fails with <<span class="odocwiki_inlinecode"|~Not~_found>> if not found~.
>>
<<pre id="VALadd" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|add>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|'value <<a_api text="table" | type Ocsipersist.table >> <<span class="ocsforge_color_delimiter"| -> >> string <<span class="ocsforge_color_delimiter"| -> >> 'value <<span class="ocsforge_color_delimiter"| -> >> unit <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>>>>>><<div class="odocwiki_info"|<<span class="odocwiki_inlinecode"|add table key value>> associates <<span class="odocwiki_inlinecode"|value>> to <<span class="odocwiki_inlinecode"|key>>~.
    ~If the database already contains data associated with <<span class="odocwiki_inlinecode"|key>>~,
    that data is discarded and silently replaced by the new data~.
>>
<<pre id="VALreplace_if_exists" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|replace~_if~_exists>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|'value <<a_api text="table" | type Ocsipersist.table >> <<span class="ocsforge_color_delimiter"| -> >> string <<span class="ocsforge_color_delimiter"| -> >> 'value <<span class="ocsforge_color_delimiter"| -> >> unit <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>>>>>><<div class="odocwiki_info"|<<span class="odocwiki_inlinecode"|replace~_if~_exists table key value>>
    associates <<span class="odocwiki_inlinecode"|value>> to <<span class="odocwiki_inlinecode"|key>> only if <<span class="odocwiki_inlinecode"|key>> is already bound~.
    ~If the database does not contain any data associated with <<span class="odocwiki_inlinecode"|key>>~,
    fails with <<span class="odocwiki_inlinecode"|~Not~_found>>~.
>>
<<pre id="VALremove" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|remove>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|'value <<a_api text="table" | type Ocsipersist.table >> <<span class="ocsforge_color_delimiter"| -> >> string <<span class="ocsforge_color_delimiter"| -> >> unit <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>>>>>><<div class="odocwiki_info"|<<span class="odocwiki_inlinecode"|remove table key>> removes the entry in the table if it exists
>>
<<pre id="VALlength" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|length>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|'value <<a_api text="table" | type Ocsipersist.table >> <<span class="ocsforge_color_delimiter"| -> >> int <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>>>>>><<div class="odocwiki_info"|~Size of a table~.
>>
<<pre id="VALiter_step" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|iter~_step>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|<<span class="ocsforge_color_delimiter"| ( >>string <<span class="ocsforge_color_delimiter"| -> >> 'a <<span class="ocsforge_color_delimiter"| -> >> unit <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>><<span class="ocsforge_color_delimiter"| ) >> <<span class="ocsforge_color_delimiter"| -> >> 'a <<a_api text="table" | type Ocsipersist.table >> <<span class="ocsforge_color_delimiter"| -> >> unit <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>>>>>><<div class="odocwiki_info"|~Important warning~: this iterator may not iter on all data of the table
    if another thread is modifying it in the same time~. ~Nonetheless~, it should
    not miss more than a very few data from time to time~, except if the table
    is very old ~(at least ~9 ~2~2~3 ~3~7~2 ~0~3~6 ~8~5~4 ~7~7~5 ~8~0~7 insertions~)~.
>>
<<pre id="VALiter_table" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|iter~_table>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|<<span class="ocsforge_color_delimiter"| ( >>string <<span class="ocsforge_color_delimiter"| -> >> 'a <<span class="ocsforge_color_delimiter"| -> >> unit <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>><<span class="ocsforge_color_delimiter"| ) >> <<span class="ocsforge_color_delimiter"| -> >> 'a <<a_api text="table" | type Ocsipersist.table >> <<span class="ocsforge_color_delimiter"| -> >> unit <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>>>>>><<div class="odocwiki_info"|~Legacy interface for iter~_step
>>
<<pre id="VALfold_step" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|fold~_step>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|\\  <<span class="ocsforge_color_delimiter"| ( >>string <<span class="ocsforge_color_delimiter"| -> >> 'a <<span class="ocsforge_color_delimiter"| -> >> 'b <<span class="ocsforge_color_delimiter"| -> >> 'b <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>><<span class="ocsforge_color_delimiter"| ) >> <<span class="ocsforge_color_delimiter"| -> >>\\  'a <<a_api text="table" | type Ocsipersist.table >> <<span class="ocsforge_color_delimiter"| -> >> 'b <<span class="ocsforge_color_delimiter"| -> >> 'b <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>>>>>><<div class="odocwiki_info"|~Important warning~: this iterator may not iter on all data of the table
    if another thread is modifying it in the same time~. ~Nonetheless~, it should
    not miss more than a very few data from time to time~, except if the table
    is very old ~(at least ~9 ~2~2~3 ~3~7~2 ~0~3~6 ~8~5~4 ~7~7~5 ~8~0~7 insertions~)~.
>>
<<pre id="VALfold_table" class="ocsforge_color odocwiki_code"|<<span class="ocsforge_color_keyword"|val>> <<span class="odocwiki_name"|fold~_table>> <<span class="ocsforge_color_delimiter"|~:>> <<span class="odocwiki_type"|\\  <<span class="ocsforge_color_delimiter"| ( >>string <<span class="ocsforge_color_delimiter"| -> >> 'a <<span class="ocsforge_color_delimiter"| -> >> 'b <<span class="ocsforge_color_delimiter"| -> >> 'b <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>><<span class="ocsforge_color_delimiter"| ) >> <<span class="ocsforge_color_delimiter"| -> >>\\  'a <<a_api text="table" | type Ocsipersist.table >> <<span class="ocsforge_color_delimiter"| -> >> 'b <<span class="ocsforge_color_delimiter"| -> >> 'b <<span class="ocsforge_color_uid"|Lwt>><<span class="ocsforge_color_delimiter"| . >><<span class="ocsforge_color_lid"|t>>>>>><<div class="odocwiki_info"|~Legacy interface for fold~_step
>>
